<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Give Feedback - PersonaTests</title>
    <meta name="description" content="Help a friend by sharing honest feedback! Quick 5-10 minute survey to tell them what you really think.">
    <link rel="stylesheet" href="styles.css">
    
    <!-- Google AdSense Verification Code -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4191191359538611"
         crossorigin="anonymous"></script>
    
    <style>
        /* 360 Feedback Styles */
        .feedback-main {
            padding: 4rem 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
        }
        
        .feedback-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Subject Info */
        .subject-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }
        
        .subject-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
            color: white;
        }
        
        .subject-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        
        .subject-role {
            color: #64748b;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .feedback-purpose {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 1rem;
            color: #0c4a6e;
            font-size: 0.9rem;
        }
        
        /* Relationship Selection */
        .relationship-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }
        
        .relationship-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .relationship-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .relationship-card:hover {
            border-color: #1e40af;
            transform: translateY(-2px);
        }
        
        .relationship-card.selected {
            border-color: #1e40af;
            background: #eff6ff;
        }
        
        .relationship-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .relationship-title {
            font-weight: bold;
            color: #1e293b;
            font-size: 0.9rem;
        }
        
        /* Feedback Form */
        .feedback-form {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }
        
        .progress-indicator {
            background: #f1f5f9;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .question-counter {
            text-align: center;
            color: #64748b;
            margin-bottom: 2rem;
            font-weight: bold;
        }
        
        .feedback-area {
            background: #f8fafc;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 4px solid #1e40af;
        }
        
        .area-header {
            margin-bottom: 1.5rem;
        }
        
        .area-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        
        .area-description {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .rating-question {
            margin-bottom: 2rem;
        }
        
        .question-text {
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        .rating-scale {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            border: 2px solid #e2e8f0;
        }
        
        .rating-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            min-width: 60px;
        }
        
        .rating-option:hover {
            background: #f1f5f9;
        }
        
        .rating-option.selected {
            background: #eff6ff;
            border: 2px solid #1e40af;
        }
        
        .rating-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 0.25rem;
        }
        
        .rating-label {
            font-size: 0.7rem;
            color: #64748b;
            text-align: center;
            font-weight: 500;
        }
        
        .open-feedback {
            margin-top: 1.5rem;
        }
        
        .feedback-textarea {
            width: 100%;
            min-height: 80px;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            box-sizing: border-box;
            font-family: inherit;
        }
        
        .feedback-textarea:focus {
            outline: none;
            border-color: #1e40af;
        }
        
        /* Navigation */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .nav-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }
        
        .nav-btn.secondary {
            background: #f1f5f9;
            color: #64748b;
        }
        
        .nav-btn.primary {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.3);
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        /* Completion Section */
        .completion-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .completion-hero {
            margin-bottom: 2rem;
        }
        
        .completion-hero h2 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 2rem;
        }
        
        .completion-hero p {
            color: #64748b;
            font-size: 1.1rem;
        }
        
        .completion-actions {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .completion-actions h3 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .completion-actions p {
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }
        
        .completion-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .completion-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .completion-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .completion-btn.primary {
            background: white;
            color: #10b981;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            /* NUCLEAR OPTION: Force hide ALL desktop language elements */
            .desktop-language-flags,
            .desktop-language-flags *,
            div[style*="display: flex"],
            div[style*="gap: 12px"] {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                position: absolute !important;
                left: -99999px !important;
                width: 0 !important;
                height: 0 !important;
                overflow: hidden !important;
                pointer-events: none !important;
            }
            
            /* Consistent 56px mobile header */
            .header {
                height: 56px !important;
                min-height: 56px !important;
                max-height: 56px !important;
            }
            
            .nav {
                height: 56px !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .nav-container {
                height: 56px !important;
                min-height: 56px !important;
                max-height: 56px !important;
                padding: 0 1rem !important;
            }
            
            .logo h1 {
                font-size: 1.1rem !important;
                line-height: 1.2 !important;
                font-weight: 800 !important;
                color: white !important;
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
            }
            
            /* Show hamburger menu on mobile */
            .mobile-menu-toggle {
                display: flex !important;
            }
            
            /* Hide desktop menu on mobile */
            .nav-menu {
                display: none !important;
            }
            
            .nav-menu.active {
                display: flex !important;
            }
            
            /* Optimized body padding */
            body {
                padding-top: 56px !important;
                padding-bottom: 60px !important;
            }
            
            /* Mobile language selector at bottom */
            .mobile-language-selector {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 10000 !important;
                padding: 1rem !important;
                backdrop-filter: blur(20px) !important;
                background: rgba(102, 126, 234, 0.95) !important;
            }
            
            .feedback-main {
                padding: 2rem 0 !important;
                min-height: calc(100vh - 140px) !important;
            }
            
            .feedback-container {
                padding: 1rem !important;
                max-width: 100% !important;
            }
            
            .relationship-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 1rem !important;
            }
            
            .rating-scale {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .rating-option {
                flex-direction: row !important;
                justify-content: center !important;
                width: 100% !important;
                min-width: auto !important;
            }
            
            .rating-number {
                margin-right: 0.5rem !important;
                margin-bottom: 0 !important;
            }
            
            .nav-buttons {
                flex-direction: column !important;
                gap: 1rem !important;
            }
            
            .nav-btn {
                width: 100% !important;
                padding: 1rem !important;
            }
            
            .completion-buttons {
                flex-direction: column !important;
                align-items: center !important;
            }
            
            .completion-btn {
                width: 100% !important;
                max-width: 300px !important;
                justify-content: center !important;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="nav-container">
                <div class="logo">
                    <h1><a href="index.html" style="color: white; text-decoration: none;">‚ú® PersonaTests</a></h1>
                </div>
                
                <!-- Mobile Menu Toggle Button (Hidden on Desktop) -->
                <div class="mobile-menu-toggle" onclick="toggleMobileMenu()" style="display: none;">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <ul class="nav-menu" id="mobileMenu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="index.html#tests">Tests</a></li>
                    <li><a href="ask-friends.html">See Who Knows Me Best</a></li>
                    <li><a href="360-assessment.html">360¬∞ Assessment</a></li>
                </ul>
            </div>
        </nav>
        
        <!-- Mobile Language Selector (Hidden on Desktop, Outside Nav Container) -->
        <div class="mobile-language-selector" style="display: none; width: 100%; background: rgba(255, 255, 255, 0.1); border-top: 1px solid rgba(255, 255, 255, 0.2); padding: 1rem;">
            <div style="text-align: center;">
                <label style="display: block; color: white; font-size: 14px; margin-bottom: 0.5rem; font-weight: 500;">üåç Choose Language</label>
                <select onchange="changeLanguage(this.value)" style="background: rgba(255, 255, 255, 0.9); border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 8px; color: #1e293b; padding: 12px 16px; font-size: 16px; font-weight: 500; cursor: pointer; outline: none; width: 100%; max-width: 300px;">
                    <option value="en" style="background: white; color: #1e293b;">üá∫üá∏ English</option>
                    <option value="es" style="background: white; color: #1e293b;">üá™üá∏ Espa√±ol</option>
                    <option value="fr" style="background: white; color: #1e293b;">üá´üá∑ Fran√ßais</option>
                    <option value="de" style="background: white; color: #1e293b;">üá©üá™ Deutsch</option>
                    <option value="it" style="background: white; color: #1e293b;">üáÆüáπ Italiano</option>
                    <option value="pt" style="background: white; color: #1e293b;">üáµüáπ Portugu√™s</option>
                    <option value="ja" style="background: white; color: #1e293b;">üáØüáµ Êó•Êú¨Ë™û</option>
                    <option value="ko" style="background: white; color: #1e293b;">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                    <option value="zh" style="background: white; color: #1e293b;">üá®üá≥ ‰∏≠Êñá</option>
                </select>
            </div>
        </div>
    </header>

    <main class="feedback-main">
        <div class="feedback-container">
            
            <!-- Subject Info -->
            <div class="subject-info">
                <div class="subject-avatar">üë§</div>
                <div class="subject-name" id="subjectName">Loading...</div>
                <div class="subject-role" id="subjectRole">Loading...</div>
                <div class="feedback-purpose" id="feedbackPurpose">
                    Your friend wants to know what you really think about them! Don't worry - your answers are totally anonymous and they won't know who said what. Be honest and helpful! üòä
                </div>
            </div>

            <!-- Relationship Selection -->
            <div class="relationship-section" id="relationshipSection">
                <h3 style="color: #1e293b; margin-bottom: 1.5rem; text-align: center;">How do you know this person? ü§î</h3>
                <div class="relationship-grid">
                    <div class="relationship-card" onclick="selectRelationship('manager')" data-relationship="manager">
                        <div class="relationship-icon">üëî</div>
                        <div class="relationship-title">Manager/Supervisor</div>
                    </div>
                    <div class="relationship-card" onclick="selectRelationship('peer')" data-relationship="peer">
                        <div class="relationship-icon">üë•</div>
                        <div class="relationship-title">Colleague/Peer</div>
                    </div>
                    <div class="relationship-card" onclick="selectRelationship('direct-report')" data-relationship="direct-report">
                        <div class="relationship-icon">üë§</div>
                        <div class="relationship-title">Direct Report</div>
                    </div>
                    <div class="relationship-card" onclick="selectRelationship('client')" data-relationship="client">
                        <div class="relationship-icon">ü§ù</div>
                        <div class="relationship-title">Client/Customer</div>
                    </div>
                    <div class="relationship-card" onclick="selectRelationship('friend')" data-relationship="friend">
                        <div class="relationship-icon">üëØ</div>
                        <div class="relationship-title">Friend</div>
                    </div>
                    <div class="relationship-card" onclick="selectRelationship('family')" data-relationship="family">
                        <div class="relationship-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <div class="relationship-title">Family Member</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="nav-btn primary" id="startFeedback" onclick="startFeedback()" disabled>
                        Let's Give Some Feedback! ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Feedback Form -->
            <div class="feedback-form" id="feedbackForm" style="display: none;">
                <!-- Progress Indicator -->
                <div class="progress-indicator">
                    <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                </div>
                
                <!-- Question Counter -->
                <div class="question-counter">
                    Area <span id="currentArea">1</span> of <span id="totalAreas">5</span>
                </div>
                
                <!-- Dynamic area content will be inserted here -->
                <div id="areaContent"></div>
                
                <!-- Navigation Buttons -->
                <div class="nav-buttons">
                    <button class="nav-btn secondary" id="prevBtn" onclick="previousArea()" disabled>
                        ‚Üê Previous Area
                    </button>
                    <button class="nav-btn primary" id="nextBtn" onclick="nextArea()">
                        Next Area ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Completion Section -->
            <div class="completion-section" id="completionSection">
                <div class="completion-hero">
                    <h2>üéâ Thanks for Being Awesome!</h2>
                    <p>Your feedback has been sent anonymously. Your honest thoughts will really help them understand themselves better!</p>
                </div>
                
                <div class="completion-actions">
                    <h3>üöÄ Curious About Yourself?</h3>
                    <p>Want to see what people think about YOU? Create your own assessment and get feedback from your friends!</p>
                    <div class="completion-buttons">
                        <a href="360-assessment.html" class="completion-btn primary">
                            üéØ See What People Think of Me
                        </a>
                        <a href="index.html" class="completion-btn">
                            üß† Take Fun Personality Tests
                        </a>
                    </div>
                </div>
            </div>
            
        </div>
    </main>

    <footer style="background: #1e293b; color: white; padding: 2rem 0;">
        <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 2rem; text-align: center;">
            <p>&copy; 2025 PersonaTests. All rights reserved. | <a href="privacy.html" style="color: #94a3b8;">Privacy Policy</a> | <a href="terms.html" style="color: #94a3b8;">Terms of Service</a></p>
        </div>
    </footer>

        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <!-- EmailJS for feedback notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script src="script.js"></script>
    <script src="firebase-social.js"></script>
    <script>
        // Initialize EmailJS
        emailjs.init('bqGKo-dBalpy6MeZE');
        
        // 360 Feedback JavaScript
        let assessmentData = null;
        let currentAreaIndex = 0;
        let feedbackResponses = {};
        let selectedRelationship = '';
        
        // Question templates for each area
        const questionTemplates = {
            'leadership': {
                title: 'How I Lead & Take Charge',
                description: 'Do I inspire people? Am I good at making decisions? Do I motivate others?',
                icon: 'üëë',
                questions: [
                    'Are they good at sharing their vision and getting people excited about it?',
                    'Do they make smart choices when things get tough?',
                    'Does this person inspire and motivate people around them?',
                    'Are they a strategic thinker who plans ahead well?'
                ]
            },
            'communication': {
                title: 'How I Talk & Listen',
                description: 'Am I a good listener? Do I explain things clearly? How\'s my texting game?',
                icon: 'üí¨',
                questions: [
                    'Do they explain things in a way that\'s easy to understand?',
                    'Are they a good listener who really pays attention?',
                    'How are they in meetings and when presenting to groups?',
                    'Are their texts/emails clear and easy to follow?'
                ]
            },
            'teamwork': {
                title: 'How I Work With Others',
                description: 'Am I easy to work with? Do I help teammates? How do I handle drama?',
                icon: 'ü§ù',
                questions: [
                    'Are they easy to work with and collaborate with?',
                    'Do they support the team and help everyone succeed?',
                    'How do they handle drama or conflicts in the group?',
                    'How positive is this person\'s impact on team dynamics?'
                ]
            },
            'emotional-intelligence': {
                title: 'My Emotional Side',
                description: 'Do I read people well? Am I aware of my feelings? How empathetic am I?',
                icon: 'üß†',
                questions: [
                    'Are they aware of their own emotions and how they affect others?',
                    'Do they really understand and care about how others feel?',
                    'How do they handle it when things get stressful or intense?',
                    'Are they good at reading the room and social vibes?'
                ]
            },
            'problem-solving': {
                title: 'How I Handle Problems',
                description: 'Am I creative with solutions? Do I think things through? Can I figure stuff out?',
                icon: 'üß©',
                questions: [
                    'Are they good at breaking down complicated problems?',
                    'Do they come up with creative and unique solutions?',
                    'Are they innovative when facing new challenges?',
                    'Do they make smart decisions when it matters?'
                ]
            },
            'adaptability': {
                title: 'How I Handle Change',
                description: 'Do I roll with the punches? Am I flexible? How do I deal when things get crazy?',
                icon: 'üåä',
                questions: [
                    'How do they handle it when things change suddenly?',
                    'Are they flexible when plans get switched up?',
                    'How quickly do they pick up new things?',
                    'Do they bounce back well when things don\'t go as planned?'
                ]
            },
            'interpersonal': {
                title: 'How I Connect With People',
                description: 'Do people trust me? Am I good at making friends? Do I build solid relationships?',
                icon: 'üåü',
                questions: [
                    'Are they good at building real, lasting relationships?',
                    'Do you trust them and find them reliable?',
                    'Are they good at connecting and networking with people?',
                    'Do they have a positive influence on others around them?'
                ]
            },
            'work-style': {
                title: 'How I Get Things Done',
                description: 'Am I organized? Do I meet deadlines? Can people count on me to deliver?',
                icon: '‚ö°',
                questions: [
                    'Are they organized and have their stuff together?',
                    'Do they manage their time well and hit deadlines?',
                    'Can you count on them to follow through?',
                    'Do they pay attention to the details and get things right?'
                ]
            }
        };
        
        async function loadAssessment() {
            const urlParams = new URLSearchParams(window.location.search);
            const assessmentId = urlParams.get('id');

            if (!assessmentId) {
                showError('Assessment not found. Please check your link.');
                return;
            }

            try {
                assessmentData = await socialFirebase.getAssessment(assessmentId);
                displaySubjectInfo();

                // Initialize feedback responses
                assessmentData.feedbackAreas.forEach(area => {
                    feedbackResponses[area] = {
                        ratings: {},
                        openFeedback: ''
                    };
                });

            } catch (error) {
                console.error('Error loading assessment:', error);
                showError('This assessment was not found, has expired, or the link is invalid.');
            }
        }
        
        function displaySubjectInfo() {
            document.getElementById('subjectName').textContent = assessmentData.subject.name;
            
            let roleText = '';
            if (assessmentData.subject.jobTitle && assessmentData.subject.organization) {
                roleText = `${assessmentData.subject.jobTitle} at ${assessmentData.subject.organization}`;
            } else if (assessmentData.subject.jobTitle) {
                roleText = assessmentData.subject.jobTitle;
            } else if (assessmentData.subject.organization) {
                roleText = assessmentData.subject.organization;
            }
            document.getElementById('subjectRole').textContent = roleText;
            
            if (assessmentData.subject.purpose) {
                document.getElementById('feedbackPurpose').innerHTML = `
                    <strong>Assessment Purpose:</strong> ${assessmentData.subject.purpose}
                    <br><br>
                    Your responses are completely anonymous and confidential.
                `;
            }
        }
        
        function selectRelationship(relationship) {
            // Clear previous selection
            document.querySelectorAll('.relationship-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select new relationship
            document.querySelector(`[data-relationship="${relationship}"]`).classList.add('selected');
            selectedRelationship = relationship;
            
            // Enable start button
            document.getElementById('startFeedback').disabled = false;
        }
        
        function startFeedback() {
            if (!selectedRelationship) {
                alert('Please select your relationship to this person first.');
                return;
            }
            
            // Hide relationship section, show feedback form
            document.getElementById('relationshipSection').style.display = 'none';
            document.getElementById('feedbackForm').style.display = 'block';
            
            // Set up form
            document.getElementById('totalAreas').textContent = assessmentData.feedbackAreas.length;
            currentAreaIndex = 0;
            displayCurrentArea();
        }
        
        function displayCurrentArea() {
            if (currentAreaIndex >= assessmentData.feedbackAreas.length) {
                completeFeedback();
                return;
            }
            
            const areaKey = assessmentData.feedbackAreas[currentAreaIndex];
            const areaData = questionTemplates[areaKey];
            
            // Update progress
            const progress = ((currentAreaIndex + 1) / assessmentData.feedbackAreas.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentArea').textContent = currentAreaIndex + 1;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentAreaIndex === 0;
            document.getElementById('nextBtn').textContent = 
                currentAreaIndex === assessmentData.feedbackAreas.length - 1 ? 'Submit Feedback ‚ú®' : 'Next Area ‚Üí';
            
            // Generate area content
            let areaHtml = `
                <div class="feedback-area">
                    <div class="area-header">
                        <div class="area-title">${areaData.icon} ${areaData.title}</div>
                        <div class="area-description">${areaData.description}</div>
                    </div>
            `;
            
            areaData.questions.forEach((question, index) => {
                const questionId = `${areaKey}_q${index}`;
                areaHtml += `
                    <div class="rating-question">
                        <div class="question-text">${question}</div>
                        <div class="rating-scale">
                            ${[1,2,3,4,5].map(rating => `
                                <div class="rating-option" onclick="selectRating('${questionId}', ${rating})" data-question="${questionId}" data-rating="${rating}">
                                    <div class="rating-number">${rating}</div>
                                    <div class="rating-label">${getRatingLabel(rating)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            areaHtml += `
                    <div class="open-feedback">
                        <div class="question-text">Additional comments or specific examples for ${areaData.title}:</div>
                        <textarea class="feedback-textarea" id="${areaKey}_open" placeholder="Share specific examples, suggestions for improvement, or additional thoughts... (optional)"></textarea>
                    </div>
                </div>
            `;
            
            document.getElementById('areaContent').innerHTML = areaHtml;
            
            // Restore previous responses
            const responses = feedbackResponses[areaKey];
            if (responses) {
                // Restore ratings
                Object.keys(responses.ratings).forEach(questionId => {
                    const rating = responses.ratings[questionId];
                    const ratingElement = document.querySelector(`[data-question="${questionId}"][data-rating="${rating}"]`);
                    if (ratingElement) {
                        ratingElement.classList.add('selected');
                    }
                });
                
                // Restore open feedback
                const openTextarea = document.getElementById(`${areaKey}_open`);
                if (openTextarea && responses.openFeedback) {
                    openTextarea.value = responses.openFeedback;
                }
            }
        }
        
        function getRatingLabel(rating) {
            const labels = {
                1: 'Needs Work',
                2: 'Getting There',
                3: 'Pretty Good',
                4: 'Really Good',
                5: 'Amazing!'
            };
            return labels[rating];
        }
        
        function selectRating(questionId, rating) {
            // Clear previous selection for this question
            document.querySelectorAll(`[data-question="${questionId}"]`).forEach(el => {
                el.classList.remove('selected');
            });
            
            // Select new rating
            document.querySelector(`[data-question="${questionId}"][data-rating="${rating}"]`).classList.add('selected');
            
            // Save response
            const areaKey = assessmentData.feedbackAreas[currentAreaIndex];
            feedbackResponses[areaKey].ratings[questionId] = rating;
        }
        
        function saveCurrentAreaData() {
            const areaKey = assessmentData.feedbackAreas[currentAreaIndex];
            const openTextarea = document.getElementById(`${areaKey}_open`);
            
            if (openTextarea) {
                feedbackResponses[areaKey].openFeedback = openTextarea.value;
            }
        }
        
        function nextArea() {
            saveCurrentAreaData();
            
            if (currentAreaIndex === assessmentData.feedbackAreas.length - 1) {
                // Submit feedback
                submitFeedback();
            } else {
                currentAreaIndex++;
                displayCurrentArea();
            }
        }
        
        function previousArea() {
            if (currentAreaIndex > 0) {
                saveCurrentAreaData();
                currentAreaIndex--;
                displayCurrentArea();
            }
        }
        
        // Send feedback notification to assessment creator
        async function sendFeedbackNotification(feedbackSubmission) {
            try {
                if (!assessmentData.emailAddress || !assessmentData.emailAddress.includes('@')) {
                    console.log('No valid creator email found, skipping notification');
                    return;
                }
                
                const resultsUrl = `${window.location.origin}/360-results.html?id=${assessmentData.id}`;
                const completedAreas = Object.keys(feedbackSubmission.responses).length;
                
                await emailjs.send('service_dc4y1ov', 'template_360_feedback_received', {
                    to_email: assessmentData.emailAddress,
                    subject_name: assessmentData.fullName || 'Assessment Creator',
                    reviewer_relationship: selectedRelationship || 'colleague',
                    completed_areas: completedAreas,
                    total_areas: assessmentData.feedbackAreas.length,
                    results_url: resultsUrl,
                    site_name: 'PersonaTests'
                });
                
                console.log('Feedback notification sent successfully');
            } catch (error) {
                console.error('Failed to send feedback notification:', error);
                // Don't block the submission if email fails
            }
        }
        
        async function submitFeedback() {
            saveCurrentAreaData();

            let totalQuestions = 0;
            let answeredQuestions = 0;

            assessmentData.feedbackAreas.forEach(areaKey => {
                const areaQuestions = questionTemplates[areaKey].questions.length;
                totalQuestions += areaQuestions;
                answeredQuestions += Object.keys(feedbackResponses[areaKey].ratings).length;
            });

            const completionRate = answeredQuestions / totalQuestions;
            if (completionRate < 0.8) {
                alert('Please complete at least 80% of the rating questions before submitting.');
                return;
            }

            // Disable button
            const submitButton = document.getElementById('nextBtn');
            submitButton.disabled = true;
            submitButton.innerHTML = 'Submitting Feedback...';

            const feedbackSubmission = {
                relationship: selectedRelationship,
                responses: feedbackResponses,
                completionRate: completionRate,
                metadata: {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                }
            };

            try {
                await socialFirebase.saveAssessmentFeedback(assessmentData.id, feedbackSubmission);
                
                // Send notification email to assessment creator
                await sendFeedbackNotification(feedbackSubmission);
                
                completeFeedback();

            } catch (error) {
                console.error('Error submitting feedback:', error);
                alert('There was an error submitting your feedback. Please try again.');
                submitButton.disabled = false;
                submitButton.innerHTML = 'Submit Feedback ‚ú®';
            }
        }
        
        function completeFeedback() {
            document.getElementById('feedbackForm').style.display = 'none';
            document.getElementById('completionSection').style.display = 'block';
            document.getElementById('completionSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showError(message) {
            document.querySelector('.feedback-container').innerHTML = `
                <div style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 3rem; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                    <h2 style="color: #1e293b; margin-bottom: 1rem;">Oops! Something went wrong</h2>
                    <p style="color: #64748b; margin-bottom: 2rem;">${message}</p>
                    <a href="360-assessment.html" style="background: #1e40af; color: white; padding: 1rem 2rem; border-radius: 25px; text-decoration: none; font-weight: bold;">
                        Create Your Own Assessment
                    </a>
                </div>
            `;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadAssessment();
        });
    </script>
</body>
</html>